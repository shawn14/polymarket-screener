<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Polymarket Screener</title>
  <style>
    :root {
      --bg: #0d1117;
      --bg-secondary: #161b22;
      --border: #30363d;
      --text: #e6edf3;
      --text-muted: #7d8590;
      --green: #3fb950;
      --red: #f85149;
      --blue: #58a6ff;
      --yellow: #d29922;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }
    
    header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    header h1 {
      font-size: 1.5rem;
      font-weight: 600;
    }
    
    header h1 span { color: var(--blue); }
    
    .refresh-btn {
      background: var(--blue);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
    }
    
    .refresh-btn:hover { opacity: 0.9; }
    
    main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.5rem;
    }
    
    .tab {
      background: transparent;
      color: var(--text-muted);
      border: none;
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-size: 0.875rem;
      border-radius: 6px;
    }
    
    .tab:hover { color: var(--text); }
    .tab.active { background: var(--bg-secondary); color: var(--text); }
    
    .panel { display: none; }
    .panel.active { display: block; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
    }
    
    .stat-card label {
      color: var(--text-muted);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .stat-card .value {
      font-size: 1.5rem;
      font-weight: 600;
      margin-top: 0.25rem;
    }
    
    .stat-card .value.positive { color: var(--green); }
    .stat-card .value.negative { color: var(--red); }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }
    
    th, td {
      text-align: left;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
    }
    
    th {
      background: var(--bg-secondary);
      color: var(--text-muted);
      font-weight: 500;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.5px;
      cursor: pointer;
    }
    
    th:hover { color: var(--text); }
    
    tr:hover td { background: var(--bg-secondary); }
    
    .positive { color: var(--green); }
    .negative { color: var(--red); }
    
    .trader-link {
      color: var(--blue);
      text-decoration: none;
    }
    
    .trader-link:hover { text-decoration: underline; }
    
    .badge {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .badge.high { background: rgba(63, 185, 80, 0.2); color: var(--green); }
    .badge.medium { background: rgba(210, 153, 34, 0.2); color: var(--yellow); }
    .badge.low { background: rgba(139, 148, 158, 0.2); color: var(--text-muted); }
    
    .signal-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    
    .signal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    
    .signal-market {
      font-weight: 600;
    }
    
    .signal-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid var(--border);
    }
    
    .signal-detail label {
      color: var(--text-muted);
      font-size: 0.75rem;
    }
    
    .whale-activity {
      max-height: 500px;
      overflow-y: auto;
    }
    
    .activity-item {
      display: flex;
      gap: 1rem;
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
    }
    
    .activity-time {
      color: var(--text-muted);
      font-size: 0.75rem;
      min-width: 80px;
    }
    
    .activity-content { flex: 1; }
    
    .activity-trader {
      color: var(--blue);
      font-weight: 500;
    }
    
    .activity-size {
      font-weight: 600;
    }
    
    .filters {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .filter-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .filter-group label {
      color: var(--text-muted);
      font-size: 0.75rem;
    }
    
    select, input {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.5rem;
      border-radius: 4px;
      font-size: 0.875rem;
    }
    
    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
    }
    
    .empty {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <header>
    <h1>üìä Polymarket <span>Screener</span></h1>
    <button class="refresh-btn" onclick="refreshData()">‚Üª Refresh</button>
  </header>
  
  <main>
    <div class="tabs">
      <button class="tab active" data-tab="leaderboard">Leaderboard</button>
      <button class="tab" data-tab="edge">üéØ Edge Traders</button>
      <button class="tab" data-tab="signals">Copy Signals</button>
      <button class="tab" data-tab="whales">Whale Activity</button>
      <button class="tab" data-tab="efficiency">Efficiency</button>
    </div>
    
    <div id="leaderboard" class="panel active">
      <div class="stats-grid" id="summary-stats"></div>
      
      <div class="filters">
        <div class="filter-group">
          <label>Period:</label>
          <select id="period-filter" onchange="renderLeaderboard()">
            <option value="day">Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
            <option value="all" selected>All Time</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Sort:</label>
          <select id="sort-filter" onchange="renderLeaderboard()">
            <option value="pnl">Profit/Loss</option>
            <option value="vol">Volume</option>
          </select>
        </div>
      </div>
      
      <table id="leaderboard-table">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Trader</th>
            <th>PnL</th>
            <th>Volume</th>
            <th>Win Rate</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <div id="edge" class="panel">
      <h2 style="margin-bottom: 1rem;">üéØ Edge Traders</h2>
      <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
        Traders ranked by edge score ‚Äî combining efficiency, win rate, profit factor, and consistency. Click to see their current positions.
      </p>
      <div id="edge-list" class="loading">Loading edge traders...</div>
    </div>
    
    <div id="signals" class="panel">
      <h2 style="margin-bottom: 1rem;">üì° Copy Trading Signals</h2>
      <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
        Signals generated when top traders take positions. Higher confidence = more traders agree.
      </p>
      <div id="signals-list" class="loading">Loading signals...</div>
    </div>
    
    <div id="whales" class="panel">
      <h2 style="margin-bottom: 1rem;">üêã Whale Activity</h2>
      <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
        Recent trades from top traders. Run <code>npm run whales</code> to start monitoring.
      </p>
      <div id="whale-list" class="whale-activity loading">Loading activity...</div>
    </div>
    
    <div id="efficiency" class="panel">
      <h2 style="margin-bottom: 1rem;">‚ö° Efficiency Leaders</h2>
      <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
        Traders ranked by PnL per dollar traded - finding the best edge.
      </p>
      <table id="efficiency-table">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Trader</th>
            <th>Efficiency</th>
            <th>Win Rate</th>
            <th>Trades</th>
            <th>Avg Win</th>
            <th>Avg Loss</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>
  
  <script>
    let data = {
      leaderboard: null,
      detailed: null,
      signals: null,
      whaleActivity: null,
      edgeTraders: null
    };
    
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
      });
    });
    
    function formatMoney(n) {
      if (n == null) return '-';
      const sign = n >= 0 ? '+' : '';
      return sign + '$' + Math.abs(n).toLocaleString('en-US', { maximumFractionDigits: 0 });
    }
    
    function formatPct(n) {
      if (n == null) return '-';
      return (n * 100).toFixed(1) + '%';
    }
    
    function timeAgo(timestamp) {
      const seconds = Math.floor((Date.now() - new Date(timestamp)) / 1000);
      if (seconds < 60) return 'just now';
      if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
      if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
      return Math.floor(seconds / 86400) + 'd ago';
    }
    
    async function fetchData() {
      try {
        const [leaderboard, detailed, signals, whaleActivity, edgeTraders] = await Promise.all([
          fetch('/api/leaderboard').then(r => r.json()),
          fetch('/api/top-detailed').then(r => r.json()),
          fetch('/api/signals').then(r => r.json()),
          fetch('/api/whale-activity').then(r => r.json()),
          fetch('/api/edge-traders').then(r => r.json()).catch(() => ({ traders: [] }))
        ]);
        
        data = { leaderboard, detailed, signals, whaleActivity, edgeTraders };
        renderAll();
      } catch (err) {
        console.error('Failed to fetch data:', err);
      }
    }
    
    function renderSummaryStats() {
      const container = document.getElementById('summary-stats');
      if (!data.leaderboard) {
        container.innerHTML = '<div class="loading">No data - run npm run fetch</div>';
        return;
      }
      
      const allPnl = data.leaderboard.all?.byPnl || [];
      const dayPnl = data.leaderboard.day?.byPnl || [];
      
      const totalPnl = allPnl.slice(0, 20).reduce((s, t) => s + (t.pnl || 0), 0);
      const todayPnl = dayPnl.slice(0, 20).reduce((s, t) => s + (t.pnl || 0), 0);
      const topTrader = allPnl[0];
      
      container.innerHTML = `
        <div class="stat-card">
          <label>Top 20 All-Time PnL</label>
          <div class="value positive">${formatMoney(totalPnl)}</div>
        </div>
        <div class="stat-card">
          <label>Top 20 Today's PnL</label>
          <div class="value ${todayPnl >= 0 ? 'positive' : 'negative'}">${formatMoney(todayPnl)}</div>
        </div>
        <div class="stat-card">
          <label>#1 All-Time</label>
          <div class="value">${topTrader?.userName || '-'}</div>
        </div>
        <div class="stat-card">
          <label>Data Updated</label>
          <div class="value" style="font-size: 1rem;">${data.leaderboard.all?.fetchedAt ? timeAgo(data.leaderboard.all.fetchedAt) : '-'}</div>
        </div>
      `;
    }
    
    function renderLeaderboard() {
      const tbody = document.querySelector('#leaderboard-table tbody');
      const period = document.getElementById('period-filter').value;
      const sort = document.getElementById('sort-filter').value;
      
      if (!data.leaderboard || !data.leaderboard[period]) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty">No data available</td></tr>';
        return;
      }
      
      const traders = sort === 'pnl' 
        ? data.leaderboard[period].byPnl 
        : data.leaderboard[period].byVolume;
      
      tbody.innerHTML = traders.slice(0, 50).map(t => {
        const detail = data.detailed?.find(d => d.proxyWallet === t.proxyWallet);
        return `
          <tr>
            <td>#${t.rank}</td>
            <td>
              <a class="trader-link" href="https://polymarket.com/profile/${t.proxyWallet}" target="_blank">
                ${t.userName}
              </a>
            </td>
            <td class="${t.pnl >= 0 ? 'positive' : 'negative'}">${formatMoney(t.pnl)}</td>
            <td>${formatMoney(t.vol)}</td>
            <td>${formatPct(detail?.winRate)}</td>
          </tr>
        `;
      }).join('');
    }
    
    function renderSignals() {
      const container = document.getElementById('signals-list');
      
      if (!data.signals || data.signals.length === 0) {
        container.innerHTML = '<div class="empty">No signals yet. Run <code>npm run copy</code> to generate signals.</div>';
        container.classList.remove('loading');
        return;
      }
      
      container.innerHTML = data.signals.slice(0, 20).map(s => {
        const confidence = s.confidence >= 0.8 ? 'high' : s.confidence >= 0.6 ? 'medium' : 'low';
        return `
          <div class="signal-card">
            <div class="signal-header">
              <span class="signal-market">${s.market}</span>
              <span class="badge ${confidence}">${(s.confidence * 100).toFixed(0)}% confidence</span>
            </div>
            <div>
              <strong class="${s.side === 'LONG' ? 'positive' : 'negative'}">${s.side}</strong> 
              ${s.outcome}
            </div>
            <div class="signal-details">
              <div class="signal-detail">
                <label>Total Size</label>
                <div>${formatMoney(s.totalSize)}</div>
              </div>
              <div class="signal-detail">
                <label>Avg Price</label>
                <div>${(s.avgPrice * 100).toFixed(1)}¬¢</div>
              </div>
              <div class="signal-detail">
                <label>Traders</label>
                <div>${s.traders.map(t => t.name).join(', ')}</div>
              </div>
              <div class="signal-detail">
                <label>Time</label>
                <div>${timeAgo(s.timestamp)}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      container.classList.remove('loading');
    }
    
    function renderWhaleActivity() {
      const container = document.getElementById('whale-list');
      
      if (!data.whaleActivity || data.whaleActivity.length === 0) {
        container.innerHTML = '<div class="empty">No whale activity yet. Run <code>npm run whales</code> to start monitoring.</div>';
        container.classList.remove('loading');
        return;
      }
      
      container.innerHTML = data.whaleActivity.slice(0, 50).map(a => `
        <div class="activity-item">
          <div class="activity-time">${timeAgo(a.timestamp)}</div>
          <div class="activity-content">
            <a class="activity-trader trader-link" href="https://polymarket.com/profile/${a.wallet}" target="_blank">
              ${a.userName}
            </a>
            <span class="${a.side === 'BUY' ? 'positive' : 'negative'}">${a.side}</span>
            ${a.outcome}
            <span class="activity-size">${formatMoney(a.size)}</span>
            <div style="color: var(--text-muted); font-size: 0.75rem;">${a.market}</div>
          </div>
        </div>
      `).join('');
      container.classList.remove('loading');
    }
    
    function renderEfficiency() {
      const tbody = document.querySelector('#efficiency-table tbody');
      
      if (!data.detailed || data.detailed.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty">No detailed data available</td></tr>';
        return;
      }
      
      const withEfficiency = data.detailed
        .filter(t => t.vol > 10000)
        .map(t => ({ ...t, efficiency: t.pnl / t.vol }))
        .sort((a, b) => b.efficiency - a.efficiency)
        .slice(0, 30);
      
      tbody.innerHTML = withEfficiency.map((t, i) => `
        <tr>
          <td>#${i + 1}</td>
          <td>
            <a class="trader-link" href="https://polymarket.com/profile/${t.proxyWallet}" target="_blank">
              ${t.userName}
            </a>
          </td>
          <td class="positive">${formatPct(t.efficiency)}</td>
          <td>${formatPct(t.winRate)}</td>
          <td>${t.totalTrades || '-'}</td>
          <td class="positive">${formatMoney(t.avgWin)}</td>
          <td class="negative">${formatMoney(t.avgLoss)}</td>
        </tr>
      `).join('');
    }
    
    function renderEdgeTraders() {
      const container = document.getElementById('edge-list');
      
      if (!data.edgeTraders || !data.edgeTraders.traders || data.edgeTraders.traders.length === 0) {
        container.innerHTML = '<div class="empty">Loading edge data...</div>';
        container.classList.remove('loading');
        return;
      }
      
      container.innerHTML = data.edgeTraders.traders.map((t, i) => `
        <div class="signal-card">
          <div class="signal-header">
            <span>
              <strong>#${i + 1}</strong>
              <a class="trader-link" href="https://polymarket.com/profile/${t.wallet}" target="_blank">
                ${t.userName}
              </a>
            </span>
            <span class="badge high">Edge: ${t.edgeScore}</span>
          </div>
          <div class="signal-details" style="margin-top: 0.75rem;">
            <div class="signal-detail">
              <label>PnL</label>
              <div class="positive">${formatMoney(t.pnl)}</div>
            </div>
            <div class="signal-detail">
              <label>Efficiency</label>
              <div>${t.efficiency}%</div>
            </div>
            <div class="signal-detail">
              <label>Win Rate</label>
              <div>${t.winRate}%</div>
            </div>
            <div class="signal-detail">
              <label>Profit Factor</label>
              <div>${t.profitFactor}x</div>
            </div>
            <div class="signal-detail">
              <label>Record</label>
              <div>${t.wins}W / ${t.losses}L</div>
            </div>
          </div>
          ${t.openPositions && t.openPositions.length > 0 ? `
            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border);">
              <label style="color: var(--text-muted); font-size: 0.75rem;">CURRENT POSITIONS</label>
              <div style="margin-top: 0.5rem;">
                ${t.openPositions.map(p => `
                  <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; font-size: 0.875rem;">
                    <span>${p.outcome} <span style="color: var(--text-muted);">@ ${p.market?.slice(0, 30)}${p.market?.length > 30 ? '...' : ''}</span></span>
                    <span>${formatMoney(p.size)} <span style="color: var(--text-muted);">(${(p.price * 100).toFixed(0)}¬¢)</span></span>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
        </div>
      `).join('');
      container.classList.remove('loading');
    }
    
    function renderAll() {
      renderSummaryStats();
      renderLeaderboard();
      renderEdgeTraders();
      renderSignals();
      renderWhaleActivity();
      renderEfficiency();
    }
    
    function refreshData() {
      fetchData();
    }
    
    // Initial load
    fetchData();
    
    // Auto-refresh every 60s
    setInterval(fetchData, 60000);
  </script>
</body>
</html>
