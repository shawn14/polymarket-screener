<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>POLYMARKET WHALE SCREENER</title>
  <style>
    :root {
      --bg: #000000;
      --bg-panel: #111111;
      --bg-header: #0a0a0a;
      --bg-row-hover: #1a1a1a;
      --bg-row-edge: rgba(255,102,0,0.06);
      --border: #222222;
      --text: #ffffff;
      --text-dim: #999999;
      --text-muted: #666666;
      --orange: #ff6600;
      --green: #00ff00;
      --red: #ff4444;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'SF Mono', 'Monaco', 'Consolas', 'Roboto Mono', monospace;
      background: var(--bg);
      color: var(--text);
      line-height: 1.4;
      font-size: 13px;
      min-height: 100vh;
    }
    
    /* Header */
    header {
      background: var(--bg-header);
      border-bottom: 2px solid var(--orange);
      padding: 0.75rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .logo-box {
      background: var(--orange);
      color: black;
      padding: 0.3rem 0.6rem;
      font-weight: bold;
      font-size: 14px;
      letter-spacing: 1px;
    }
    
    .logo-text {
      color: var(--text);
      font-size: 13px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    
    .header-stats {
      display: flex;
      gap: 2rem;
      font-size: 11px;
    }
    
    .header-stat {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    
    .header-stat label {
      color: var(--text-muted);
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .header-stat .value {
      color: var(--orange);
      font-weight: bold;
      font-size: 14px;
    }
    
    .header-stat .value.positive { color: var(--green); }
    .header-stat .value.negative { color: var(--red); }
    
    /* Filter Bar */
    .filter-bar {
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 1.5rem;
      display: flex;
      gap: 1.5rem;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .filter-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .filter-group label {
      color: var(--text-muted);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    select, input[type="text"] {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.4rem 0.6rem;
      font-family: inherit;
      font-size: 11px;
      border-radius: 2px;
    }
    
    select:focus, input:focus {
      outline: none;
      border-color: var(--orange);
    }
    
    input[type="text"] {
      width: 180px;
    }
    
    .btn {
      background: var(--bg);
      color: var(--orange);
      border: 1px solid var(--orange);
      padding: 0.4rem 0.75rem;
      font-family: inherit;
      font-size: 10px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-radius: 2px;
    }
    
    .btn:hover {
      background: var(--orange);
      color: black;
    }
    
    .btn.active {
      background: var(--orange);
      color: black;
    }
    
    .filter-spacer {
      flex: 1;
    }
    
    .live-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-muted);
      font-size: 10px;
    }
    
    .live-dot {
      width: 8px;
      height: 8px;
      background: var(--green);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    
    /* Main Table */
    main {
      padding: 0;
    }
    
    .table-container {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    
    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    th {
      background: var(--bg-panel);
      color: var(--orange);
      font-weight: 500;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 0.6rem 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }
    
    th:hover {
      background: var(--bg-row-hover);
    }
    
    th.sorted {
      color: var(--text);
    }
    
    th.sorted::after {
      content: ' ‚ñº';
      font-size: 8px;
    }
    
    th.sorted.asc::after {
      content: ' ‚ñ≤';
    }
    
    th.col-num {
      text-align: right;
    }
    
    td {
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }
    
    tr:hover td {
      background: var(--bg-row-hover);
    }
    
    tr.edge-row td {
      background: var(--bg-row-edge);
    }
    
    tr.edge-row:hover td {
      background: rgba(255,102,0,0.12);
    }
    
    .col-num {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    
    .positive { color: var(--green); }
    .negative { color: var(--red); }
    .dim { color: var(--text-dim); }
    .highlight { color: var(--orange); }
    
    .trader-link {
      color: var(--text);
      text-decoration: none;
    }
    
    .trader-link:hover {
      color: var(--orange);
    }
    
    .badge {
      display: inline-block;
      padding: 2px 5px;
      font-size: 9px;
      font-weight: bold;
      border-radius: 2px;
      margin-left: 6px;
      vertical-align: middle;
    }
    
    .badge-edge {
      background: var(--orange);
      color: black;
    }
    
    .badge-buy {
      background: var(--green);
      color: black;
    }
    
    .badge-sell {
      background: var(--red);
      color: white;
    }
    
    .alert-cell {
      text-align: center;
    }
    
    .alert-badge {
      font-size: 16px;
      cursor: help;
    }
    
    .alert-copy {
      filter: drop-shadow(0 0 4px var(--orange));
    }
    
    .alert-whale {
      opacity: 0.8;
    }
    
    .side-cell {
      font-weight: bold;
    }
    
    .market-cell {
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .outcome-cell {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-muted);
    }
    
    .empty-state h2 {
      color: var(--text-dim);
      font-size: 16px;
      margin-bottom: 0.5rem;
    }
    
    /* Stats row */
    .stats-row {
      display: flex;
      gap: 2rem;
      padding: 0.75rem 1.5rem;
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      font-size: 11px;
    }
    
    .stat-item {
      display: flex;
      gap: 0.5rem;
    }
    
    .stat-item label {
      color: var(--text-muted);
    }
    
    .stat-item .value {
      font-weight: bold;
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--bg);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }
    
    /* Mobile */
    @media (max-width: 768px) {
      header {
        flex-direction: column;
        gap: 0.75rem;
        padding: 0.5rem 1rem;
      }
      
      .header-stats {
        gap: 1rem;
      }
      
      .filter-bar {
        padding: 0.5rem 1rem;
        gap: 0.75rem;
      }
      
      .filter-group label {
        display: none;
      }
      
      input[type="text"] {
        width: 120px;
      }
      
      table {
        font-size: 11px;
      }
      
      th, td {
        padding: 0.4rem 0.5rem;
      }
      
      .hide-mobile {
        display: none;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <div class="logo-box">PM</div>
      <div class="logo-text">Whale Alerts</div>
    </div>
    <div class="header-stats">
      <div class="header-stat">
        <label>Trades</label>
        <span class="value" id="stat-count">-</span>
      </div>
      <div class="header-stat">
        <label>Buy Volume</label>
        <span class="value positive" id="stat-buy-vol">-</span>
      </div>
      <div class="header-stat">
        <label>Sell Volume</label>
        <span class="value negative" id="stat-sell-vol">-</span>
      </div>
      <div class="header-stat">
        <label>Updated</label>
        <span class="value" id="stat-updated">-</span>
      </div>
    </div>
  </header>
  
  <div class="filter-bar">
    <div class="filter-group">
      <label>Search</label>
      <input type="text" id="filter-search" placeholder="Trader or market..." oninput="renderTable()">
    </div>
    
    <div class="filter-group">
      <label>Side</label>
      <select id="filter-side" onchange="renderTable()">
        <option value="all">All</option>
        <option value="BUY">Buy</option>
        <option value="SELL">Sell</option>
      </select>
    </div>
    
    <div class="filter-group">
      <label>Alert Type</label>
      <select id="filter-edge" onchange="renderTable()">
        <option value="all">All Alerts</option>
        <option value="edge">üéØ Copy Signals</option>
        <option value="whale">üêã Whale Only</option>
      </select>
    </div>
    
    <div class="filter-group">
      <label>Min Size</label>
      <select id="filter-size" onchange="renderTable()">
        <option value="0">Any</option>
        <option value="10000">$10K+</option>
        <option value="25000">$25K+</option>
        <option value="50000">$50K+</option>
        <option value="100000">$100K+</option>
      </select>
    </div>
    
    <div class="filter-spacer"></div>
    
    <div class="live-indicator">
      <div class="live-dot"></div>
      <span>LIVE</span>
    </div>
    
    <button class="btn" onclick="refreshData()">Refresh</button>
  </div>
  
  <div class="stats-row">
    <div class="stat-item">
      <label>Showing:</label>
      <span class="value" id="stat-showing">-</span>
    </div>
    <div class="stat-item">
      <label>üéØ Copy Signals:</label>
      <span class="value highlight" id="stat-copy">-</span>
    </div>
    <div class="stat-item">
      <label>üêã Whale Alerts:</label>
      <span class="value" id="stat-whale">-</span>
    </div>
    <div class="stat-item">
      <label>Avg Size:</label>
      <span class="value" id="stat-avg-size">-</span>
    </div>
  </div>
  
  <main>
    <div class="table-container">
      <table id="whale-table">
        <thead>
          <tr>
            <th style="width: 40px;">Alert</th>
            <th data-sort="timestamp" class="sorted">Time</th>
            <th data-sort="userName">Trader</th>
            <th data-sort="side">Side</th>
            <th data-sort="outcome">Outcome</th>
            <th data-sort="market" class="hide-mobile">Market</th>
            <th data-sort="price" class="col-num">Price</th>
            <th data-sort="size" class="col-num">Size</th>
          </tr>
        </thead>
        <tbody id="table-body">
          <tr>
            <td colspan="8" class="empty-state">
              <h2>Loading Telegram alerts...</h2>
              <p>Fetching trades sent to @Pmwhale_bot</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>
  
  <script>
    let rawData = [];
    let sortColumn = 'timestamp';
    let sortAsc = false;
    
    function formatMoney(n, compact = true) {
      if (n == null) return '-';
      const abs = Math.abs(n);
      if (compact && abs >= 1000000) {
        return '$' + (abs / 1000000).toFixed(2) + 'M';
      }
      if (compact && abs >= 1000) {
        return '$' + (abs / 1000).toFixed(1) + 'K';
      }
      return '$' + abs.toLocaleString('en-US', { maximumFractionDigits: 0 });
    }
    
    function timeAgo(timestamp) {
      let ts = timestamp;
      if (typeof ts === 'number' && ts < 10000000000) {
        ts = ts * 1000;
      }
      const seconds = Math.floor((Date.now() - new Date(ts)) / 1000);
      if (seconds < 0) return 'now';
      if (seconds < 60) return seconds + 's ago';
      if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
      if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
      return Math.floor(seconds / 86400) + 'd ago';
    }
    
    function getTimestamp(item) {
      const ts = item.timestamp;
      return (typeof ts === 'number' && ts < 10000000000) ? ts * 1000 : new Date(ts).getTime();
    }
    
    async function fetchData() {
      try {
        const res = await fetch('/api/whale-activity');
        rawData = await res.json();
        renderTable();
        updateStats();
      } catch (err) {
        console.error('Failed to fetch:', err);
        document.getElementById('table-body').innerHTML = `
          <tr><td colspan="7" class="empty-state">
            <h2>Failed to load data</h2>
            <p>${err.message}</p>
          </td></tr>
        `;
      }
    }
    
    function getFilteredData() {
      const search = document.getElementById('filter-search').value.toLowerCase();
      const side = document.getElementById('filter-side').value;
      const edge = document.getElementById('filter-edge').value;
      const minSize = parseInt(document.getElementById('filter-size').value) || 0;
      
      let filtered = rawData.filter(item => {
        if (side !== 'all' && item.side !== side) return false;
        if (edge === 'edge' && !item.isEdgeTrader && !item.isCopyCandidate) return false;
        if (edge === 'whale' && (item.isEdgeTrader || item.isCopyCandidate)) return false;
        if (item.size < minSize) return false;
        if (search) {
          const searchIn = (item.userName + ' ' + item.market + ' ' + item.outcome).toLowerCase();
          if (!searchIn.includes(search)) return false;
        }
        return true;
      });
      
      // Sort
      filtered.sort((a, b) => {
        let aVal, bVal;
        
        switch (sortColumn) {
          case 'timestamp':
            aVal = getTimestamp(a);
            bVal = getTimestamp(b);
            break;
          case 'size':
            aVal = a.size || 0;
            bVal = b.size || 0;
            break;
          case 'price':
            aVal = a.price || 0;
            bVal = b.price || 0;
            break;
          case 'userName':
            aVal = (a.userName || '').toLowerCase();
            bVal = (b.userName || '').toLowerCase();
            break;
          case 'side':
            aVal = a.side || '';
            bVal = b.side || '';
            break;
          case 'outcome':
            aVal = (a.outcome || '').toLowerCase();
            bVal = (b.outcome || '').toLowerCase();
            break;
          case 'market':
            aVal = (a.market || '').toLowerCase();
            bVal = (b.market || '').toLowerCase();
            break;
          default:
            aVal = getTimestamp(a);
            bVal = getTimestamp(b);
        }
        
        if (typeof aVal === 'string') {
          return sortAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        }
        return sortAsc ? aVal - bVal : bVal - aVal;
      });
      
      return filtered;
    }
    
    function renderTable() {
      const tbody = document.getElementById('table-body');
      const filtered = getFilteredData();
      
      // Update sort indicators
      document.querySelectorAll('th[data-sort]').forEach(th => {
        th.classList.remove('sorted', 'asc');
        if (th.dataset.sort === sortColumn) {
          th.classList.add('sorted');
          if (sortAsc) th.classList.add('asc');
        }
      });
      
      if (!filtered.length) {
        tbody.innerHTML = `
          <tr><td colspan="8" class="empty-state">
            <h2>No trades found</h2>
            <p>Try adjusting your filters</p>
          </td></tr>
        `;
        updateFilteredStats(filtered);
        return;
      }
      
      tbody.innerHTML = filtered.map(item => {
        const isEdge = item.isEdgeTrader || item.isCopyCandidate;
        const priceDisplay = item.price ? (item.price * 100).toFixed(1) + '¬¢' : '-';
        const alertEmoji = isEdge ? 'üéØ' : 'üêã';
        const alertType = isEdge ? 'COPY' : 'WHALE';
        
        return `
          <tr class="${isEdge ? 'edge-row' : ''}">
            <td class="alert-cell" title="${isEdge ? 'Copy Signal - Edge Trader' : 'Whale Alert'}">
              <span class="alert-badge ${isEdge ? 'alert-copy' : 'alert-whale'}">${alertEmoji}</span>
            </td>
            <td class="dim">${timeAgo(item.timestamp)}</td>
            <td>
              <a class="trader-link" href="https://polymarket.com/profile/${item.wallet}" target="_blank">
                ${item.userName || 'Unknown'}
              </a>
            </td>
            <td class="side-cell ${item.side === 'BUY' ? 'positive' : 'negative'}">
              ${item.side}
            </td>
            <td class="outcome-cell" title="${item.outcome || ''}">${item.outcome || '-'}</td>
            <td class="market-cell dim hide-mobile" title="${item.market || ''}">${item.market || '-'}</td>
            <td class="col-num">${priceDisplay}</td>
            <td class="col-num ${item.side === 'BUY' ? 'positive' : 'negative'}" style="font-weight: bold;">
              ${formatMoney(item.size)}
            </td>
          </tr>
        `;
      }).join('');
      
      updateFilteredStats(filtered);
    }
    
    function updateStats() {
      if (!rawData.length) return;
      
      const buyVol = rawData.filter(t => t.side === 'BUY').reduce((s, t) => s + (t.size || 0), 0);
      const sellVol = rawData.filter(t => t.side === 'SELL').reduce((s, t) => s + (t.size || 0), 0);
      
      document.getElementById('stat-count').textContent = rawData.length;
      document.getElementById('stat-buy-vol').textContent = formatMoney(buyVol);
      document.getElementById('stat-sell-vol').textContent = formatMoney(sellVol);
      document.getElementById('stat-updated').textContent = 'now';
    }
    
    function updateFilteredStats(filtered) {
      const copyCount = filtered.filter(t => t.isEdgeTrader || t.isCopyCandidate).length;
      const whaleCount = filtered.length - copyCount;
      const avgSize = filtered.length > 0 
        ? filtered.reduce((s, t) => s + (t.size || 0), 0) / filtered.length 
        : 0;
      
      document.getElementById('stat-showing').textContent = filtered.length + ' alerts';
      document.getElementById('stat-copy').textContent = copyCount;
      document.getElementById('stat-whale').textContent = whaleCount;
      document.getElementById('stat-avg-size').textContent = formatMoney(avgSize);
    }
    
    function refreshData() {
      fetchData();
    }
    
    // Column sorting
    document.querySelectorAll('th[data-sort]').forEach(th => {
      th.addEventListener('click', () => {
        const col = th.dataset.sort;
        if (sortColumn === col) {
          sortAsc = !sortAsc;
        } else {
          sortColumn = col;
          sortAsc = false;
        }
        renderTable();
      });
    });
    
    // Initial load
    fetchData();
    
    // Auto-refresh every 30s
    setInterval(fetchData, 30000);
  </script>
</body>
</html>
